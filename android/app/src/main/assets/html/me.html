<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0 Transitional//EN">
<HTML>
<HEAD>
	<TITLE>知途 > 我的</TITLE>
	<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">

	<link rel="stylesheet" type="text/css" href="css/mint.min.css" />
	<link rel="stylesheet" type="text/css" href="css/muse-ui.css" />
	<link rel="stylesheet" type="text/css" href="css/muse-ui-toast.all.css" />
	<link rel="stylesheet" type="text/css" href="css/material-icons.css" />
	<link rel="stylesheet" type="text/css" href="css/muse-ui-loading.all.css" />
	<link rel="stylesheet" type="text/css" href="css/muse-ui-message.all.css" />
	<link rel="stylesheet" type="text/css" href="css/common.css" />

	<script src="js/jquery.min-1.11.3.js"></script>
	<script src="js/JSConstants.js"></script>
	<script src="js/JSBridge.js"></script>
	<script src="js/JSBridgeExt.js"></script>
	<script src="js/common.js"></script>
	<script src="js/vue.min.js"></script>
	<script src="js/mint.min.js"></script>
	<script src="js/muse-ui.js"></script>
	<script src="js/muse-ui-toast.js"></script>
	<script src="js/muse-ui-loading.js"></script>
	<script src="js/muse-ui-message.js"></script>

	<style type="text/css">
		.mint-cell-wrapper{
			background-image:none;
		}
		.mint-cell:last-child{
			background-image:none;
		}

		.menu-item{
			margin-top: 0px;
			padding-left: 10px;
			border-bottom: 1px solid #ddd;
		}

		.alert-button .mu-dialog-actions button{
			margin: 0 auto;
  			display: block;
			font-size: 14px;
			background-color: #C63300;
			color: #fff;
		}

		.me-info{
			background-color: #4682B4;
		}

		.me-info .nickname{
		    color: white;
		}

        .me-info .edit-button{
            color: white;
            font-size: 18px;
            font-weight: 600;
            margin-left: 15px;
        }

		.mu-avatar img{
		    width: 48px;
		    height: 48px;
		}

		/** dialog css **/
        .nickname-edit-dialog .mu-dialog-body{
            padding: 0px 0px 10px 0;
        }

        .nickname-edit-dialog .dialog-form-title{
            font-weight: 600;
            height: 45px;
			background-color: #2196f3;
			color: #fff;
        }

		.nickname-edit-dialog .dialog-form-item{
		    height: 70px;
		}

		.nickname-edit-dialog .dialog-form-button{
		    height: 40px;
		}
	</style>
</HEAD>
<BODY>
	<div id="app">
		<table width="100%" border="0" class="me-info">
			<tr>
				<td width="80" height="100" align="center">
					<mu-avatar>
						<img src="images/head1.png" width="48" height="48" alt="头像">
					</mu-avatar>
				</td>
                <td class="nickname" @click="editNickname">{{ nickname }} <span class="edit-button">&gt;</span></td>
			</tr>
		</table>

		<div class="menu-item" @click="viewTrack">
			<mt-cell title="我的轨迹" is-link></mt-cell>
		</div>

		<div class="menu-item" @click="fixedPointCategory">
			<mt-cell title="定点位置类别设置" is-link></mt-cell>
		</div>

		<div class="menu-item">
			<mt-cell title="用户协议" is-link></mt-cell>
		</div>

		<div class="menu-item">
			<mt-cell title="隐私政策" is-link></mt-cell>
		</div>

		<div class="menu-item" @click="getLastedVersion">
			<mt-cell title="版本更新" is-link>
				<span style="color:#999;padding-right:20px;">当前版本: {{ currentVersion }}</span>
                <mu-badge content="news" color="secondary" v-show="hasLastedVersion"></mu-badge>
			</mt-cell>
		</div>

		<div @click="cancelAccount" class="menu-item">
			<mt-cell title="永久销户" is-link></mt-cell>
		</div>

		<div @click="exitApp" style="margin-top:30px; color:blue; text-align:center; font-weight:600;">
			<mt-cell title="退出登录"></mt-cell>
		</div>

		<table class="tabbar" width="100%">
			<tr>
				<td width="25%" align="center" class="tabbar-item" @click="changeTabPage('main.html')">
					<img src="images/home.jpg">
					<div>主页</div>
				</td>
				<td width="25%" align="center" class="tabbar-item" @click="changeTabPage('contact.html')">
					<img src="images/alert.jpg">
					<div>求助</div>
				</td>
				<td width="25%" align="center" class="tabbar-item" @click="pointNavigation">
					<img src="images/navigation.png">
					<div>定点导航</div>
				</td>
				<td width="25%" align="center" class="tabbar-item" @click="changeTabPage('messages.html')">
					<img src="images/message.jpg">
					<div>消息</div>
				</td>
				<td width="25%" align="center" class="tabbar-item" @click="changeTabPage('me.html')">
					<img src="images/person.jpg">
					<div class="tabbar-item-selected">我的</div>
				</td>
			</tr>
		</table>

        <mu-dialog transition="slide-left" width="260" dialog-class="nickname-edit-dialog"
                   :overlay="false" :esc-press-close="false" :overlay-close="false" :open.sync="openEditDialog">
            <table width="100%" border="0">
                <tr>
                    <td align="center" class="dialog-form-title">修改昵称</td>
                </tr>
                <tr class="dialog-form-item">
                    <td align="center">
                        <input type="text" style="height:35px;" size="20" maxlength="20" v-model.trim="new_nickname"/>
                    </td>
                </tr>
                <tr class="dialog-form-button">
                    <td align="center">
                        <mt-button type="default" size="small" @click="closeEditDialog" style="width:80px;">取消</mt-button>&nbsp;&nbsp;
                        <mt-button type="primary" size="small" @click="saveNickname" style="width:80px;">保存</mt-button>
                    </td>
                </tr>
            </table>
        </mu-dialog>
	</div>

	<script>
	    var downloadURL = "";

		var vm = new Vue({
			el: '#app',
			data: {
				nickname: "",
				currentVersion: "",
				hasLastedVersion: false,

				openEditDialog: false,
				new_nickname: ""
			},
			methods: {
				changeTabPage: function(pageURL){
					transferPage(pageURL);
				},
				pointNavigation: function(){
					jsBridge.dispatchAction("LocationAction", JSON.stringify({}), "pointNavigation");
				},
				viewTrack: function(){
					jsBridge.dispatchAction("LocationAction", JSON.stringify({"userId": "me", "nickName":"我自己"}), "viewTrack");
				},
				fixedPointCategory: function(){
					transferPage("fixed_point_category_list.html");
				},
				editNickname: function(){
				    this.new_nickname = this.nickname;
					this.openEditDialog = true;
				},
				closeEditDialog: function(){
				    this.new_nickname = "";
					this.openEditDialog = false;
				},
				saveNickname: function(){
                    if(this.new_nickname == ""){
						this.$toast.message('请输入新昵称');
						return;
					}

					var obj = {"new_nickname": this.new_nickname};
					var result = jsBridge.dispatchAction("UserAction", JSON.stringify(obj), "updateNickname");

					if(result == "success"){
						this.nickname = this.new_nickname;
						this.$toast.message('保存成功');
						this.closeEditDialog();
					}else{
						this.$toast.message(result);
					}
				},
				getLastedVersion: function(){
                    if(downloadURL == ""){
                        this.$toast.message("当前已是最新版本");
                    }else{
                        this.$confirm("有新版本，是否要更新？", '提示', {
                            okLabel: "下载"
                        }).then(({ result }) => {
                            if (result) {
                                window.open(downloadURL);
                            }
                        });
                    }
				},
				cancelAccount: function(){
					var message = "销户会彻底删除您的会员信息、位置信息、好友信息及关联的所有信息，确认是否销户？";
					this.$confirm(message, '销户提示', {
						okLabel: "销户",
						maxWidth: '80%'
					}).then(({ result }) => {
						if (result) {
						  	this.$confirm("销户会删除用户所有的信息，您是否真的确认销户？", '销户再次提示', {

							}).then(({ result }) => {
								if (result) {
									var result = jsBridge.dispatchAction("UserAction", "", "cancelAccount");
									if(result == "success"){
										this.$alert("您的账户已成功注销，可正常退出应用！", "温馨提示", {
											okLabel: "退出",
											className: "alert-button"
										}).then(() => {
											jsBridge.dispatchAction(actionNames.ExitApp, "", "");
										});
									}else{
										this.$toast.error("销户失败！");
									}
								}
							});
						}
      				});
				},
				exitApp: function(){
					this.$confirm("确定要退出应用？", '提示', {

					}).then(({ result }) => {
						if (result) {
							jsBridge.dispatchAction(actionNames.ExitApp, "", "");
						}
					});
				}
			}
		})
	</script>

	<script type="text/javascript">
        function pageFinishCallback(){
            var jsonStr = jsBridge.dispatchAction("UserAction", "", "my-info");
            var jsonObject = jQuery.parseJSON(jsonStr);

            vm.nickname = jsonObject.nickname;
			vm.currentVersion = jsonObject.currentVersion;
            downloadURL = jsonObject.downloadURL;
            vm.hasLastedVersion = (downloadURL != "");
        }
    </script>
</BODY>
</HTML>
